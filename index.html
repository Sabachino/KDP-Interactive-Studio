<!DOCTYPE html>
<html lang="it">
<head>
    <script src="https://js.stripe.com/v3/"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDP Cover Designer Pro - Full Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;700;900&family=Lato&family=Libre+Baskerville&family=Merriweather&family=Montserrat:wght@400;700;900&family=Oswald&family=Playfair+Display:wght@400;700;900&family=Roboto&family=Roboto+Condensed&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #111827; }
        
        /* LOADER */
        .banana-loader {
            width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #F59E0B;
            border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI SCROLLBAR */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1F2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        /* CANVAS CONTAINER & SCALING */
        #workspace-viewport {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1f2937; /* Dark Gray bg behind canvas */
            background-image: radial-gradient(#374151 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #scaler-container {
            transform-origin: center center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: transform 0.1s ease-out; /* Smooth Zoom */
        }

        #interactiveArea {
            position: relative;
            overflow: hidden;
            background-color: #fff;
            user-select: none;
            /* L'immagine di sfondo sarà gestita via JS */
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover; 
        }

        /* DRAGGABLE ELEMENTS */
        .draggable-item {
            position: absolute;
            cursor: grab;
            border: 1px solid transparent; 
            white-space: nowrap;
            z-index: 100;
            line-height: 1.2;
            transform-origin: center center;
        }
        .draggable-item:hover { border: 1px dashed rgba(255, 255, 255, 0.5); }
        .draggable-item.selected { 
            border: 1px dashed #F59E0B !important; 
            cursor: grabbing;
            z-index: 1000; /* Bring to front */
        }

        /* LAYERS (Barcode, Guides) */
        #guidesOverlay {
            position: absolute; inset: 0; pointer-events: none; z-index: 900;
            display: none; /* Hidden by default */
        }
        .guide-line { position: absolute; border: 1px dashed #ef4444; opacity: 0.8; }
        .guide-label { 
            position: absolute; font-size: 10px; color: #ef4444; font-weight: bold; 
            background: rgba(0,0,0,0.7); padding: 2px 4px; pointer-events: none;
        }
        .safe-zone-box {
            position: absolute; border: 1px dashed #3b82f6; opacity: 0.5; pointer-events: none;
        }

        #barcodeArea {
            position: absolute;
            width: 280px; height: 160px; /* High Res dimensions relative to canvas */
            background-color: #ffffff;
            display: none; /* Hidden by default */
            z-index: 800;
            border: 4px solid white;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        #barcodeLines {
            width: 90%; height: 70%;
            background-image: repeating-linear-gradient(90deg, #000 0px, #000 4px, #fff 4px, #fff 8px);
        }
        #barcodeText {
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 24px; color: black; margin-top: 5px;
        }

        /* UTILS */
        .text-shadow-strong { text-shadow: 2px 2px 4px #000; }
        input[type=range] { accent-color: #F59E0B; cursor: pointer; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <nav class="bg-gray-800 border-b border-gray-700 h-16 flex-none z-50 shadow-lg">
        <div class="w-full h-full px-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-book-open text-yellow-500 text-2xl"></i>
                <h1 class="text-xl font-bold text-white tracking-wide">KDP PRO <span class="text-yellow-500">STUDIO</span></h1>
            </div>
            
            <div id="topInfoBar" class="hidden flex items-center gap-4 bg-gray-900 px-4 py-1.5 rounded-full border border-gray-600">
                <span id="canvasDimensionsDisplay" class="text-xs text-orange-400 font-mono font-bold uppercase tracking-wider"></span>
                <span class="text-gray-600">|</span>
                <span class="text-xs text-gray-300 flex items-center gap-2"><i class="fa-solid fa-mouse-pointer text-yellow-500"></i> Trascina elementi</span>
            </div>

            <div class="flex items-center gap-4">
                <button id="resetBtn" class="bg-red-600 hover:bg-red-500 text-white px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-trash-can"></i> Reset
                </button>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">
        
        <aside class="w-80 flex-none bg-gray-800 border-r border-gray-700 overflow-y-auto custom-scrollbar p-4 flex flex-col gap-6 z-20">
            
            <div class="space-y-4">
                <h2 class="text-sm font-bold text-fuchsia-400 uppercase tracking-wider border-b border-gray-700 pb-2">1. Generazione AI</h2>
                <div>
                    <label class="text-[10px] text-gray-400 uppercase font-bold">Titolo</label>
                    <input type="text" id="titleInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white focus:border-fuchsia-500 outline-none" placeholder="Titolo del libro">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 uppercase font-bold">Prompt / Tema</label>
                    <textarea id="mood" rows="2" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white focus:border-fuchsia-500 outline-none" placeholder="Descrivi la copertina..."></textarea>
                </div>
                <button id="runAgentsBtn" class="w-full bg-gradient-to-r from-fuchsia-600 to-purple-600 hover:from-fuchsia-500 text-white font-bold py-3 rounded shadow-lg text-xs uppercase tracking-wide transition transform hover:scale-[1.02]">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Genera HD (1600x2560)
                </button>
                <div class="text-[10px] text-gray-500 text-center">Formato nativo verticale bloccato.</div>
            </div>

            <div id="editingTools" class="hidden space-y-4 animate-fade-in">
                <h2 class="text-sm font-bold text-yellow-400 uppercase tracking-wider border-b border-gray-700 pb-2">2. Editor Elementi</h2>
                
                <div class="grid grid-cols-2 gap-2">
                    <button id="addTextBtn" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs font-bold border border-gray-600"><i class="fa-solid fa-font mr-1"></i> Testo</button>
                    <button id="addShapeBtn" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs font-bold border border-gray-600"><i class="fa-solid fa-square mr-1"></i> Box</button>
                </div>

                <div id="inspectorPanel" class="bg-gray-900 p-3 rounded border border-gray-700 hidden">
                    <p class="text-[10px] text-yellow-500 font-bold mb-2 uppercase">Proprietà Selezione</p>
                    
                    <div id="textControls" class="hidden space-y-2">
                        <input type="text" id="elContent" class="w-full bg-gray-800 border border-gray-600 rounded p-1 text-xs text-white">
                        <div class="flex gap-2">
                            <input type="color" id="elColor" class="h-6 w-8 bg-transparent border-0 cursor-pointer">
                            <input type="range" id="elSize" min="10" max="400" class="flex-1">
                        </div>
                        <div class="flex justify-between">
                            <button id="alignLeft" class="text-gray-400 hover:text-white"><i class="fa-solid fa-align-left"></i></button>
                            <button id="alignCenter" class="text-gray-400 hover:text-white"><i class="fa-solid fa-align-center"></i></button>
                            <button id="alignRight" class="text-gray-400 hover:text-white"><i class="fa-solid fa-align-right"></i></button>
                        </div>
                    </div>

                    <button id="deleteElBtn" class="w-full mt-2 bg-red-900/50 text-red-200 text-[10px] py-1 rounded hover:bg-red-900 border border-red-800">Elimina</button>
                </div>
            </div>

            <div id="exportKindleSection" class="hidden border-t border-gray-700 pt-4">
                <button id="dlKindleBtn" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-3 rounded text-xs uppercase shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-brands fa-amazon"></i> Scarica JPG Kindle
                </button>
            </div>

            <div id="paperbackSection" class="hidden space-y-4 border-t border-gray-700 pt-4 animate-fade-in">
                <h2 class="text-sm font-bold text-orange-400 uppercase tracking-wider border-b border-gray-700 pb-2">4. Layout Stampa (KDP)</h2>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold">Pagine</label>
                        <input type="number" id="pageCount" value="120" min="24" class="w-full bg-gray-900 border border-orange-900 rounded p-1.5 text-xs text-white">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold">Carta</label>
                        <select id="paperType" class="w-full bg-gray-900 border border-orange-900 rounded p-1.5 text-xs text-white">
                            <option value="white">Bianca</option>
                            <option value="cream">Crema</option>
                            <option value="color">Colori</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold">Spina</label>
                        <input type="color" id="spineColor" value="#F59E0B" class="w-full h-6 rounded cursor-pointer">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold">Retro</label>
                        <input type="color" id="backColor" value="#111827" class="w-full h-6 rounded cursor-pointer">
                    </div>
                </div>

                <button id="initPaperbackBtn" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 text-white font-bold py-3 rounded shadow-lg text-xs uppercase flex items-center justify-center gap-2">
                    <i class="fa-solid fa-print"></i> Genera Formato Stampa
                </button>

                <div id="paperbackToggles" class="hidden space-y-2 bg-gray-900 p-2 rounded border border-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-300">Guide KDP (Rosso)</span>
                        <input type="checkbox" id="toggleGuides" class="accent-orange-500 h-4 w-4">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-300">Barcode ISBN</span>
                        <input type="checkbox" id="toggleBarcode" class="accent-orange-500 h-4 w-4">
                    </div>
                </div>

                <button id="dlPrintBtn" class="hidden w-full bg-orange-500 hover:bg-orange-400 text-white text-shadow-strong font-bold py-3 rounded shadow-lg text-xs uppercase flex items-center justify-center gap-2 mt-2">
                    <i class="fa-solid fa-file-pdf"></i> Scarica File Stampa HD
                </button>
            </div>

        </aside>

        <main id="workspace-viewport">
            
            <div id="loader" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-gray-900/95 backdrop-blur-sm">
                <div class="banana-loader mb-4"></div>
                <p id="loaderText" class="text-yellow-500 font-mono text-sm animate-pulse">ELABORAZIONE GRAFICA IN CORSO...</p>
            </div>

            <div id="placeholder" class="text-gray-500 flex flex-col items-center pointer-events-none">
                <i class="fa-solid fa-layer-group text-6xl mb-4 opacity-20"></i>
                <p class="text-sm font-mono uppercase tracking-widest">In attesa di generazione...</p>
            </div>

            <div id="scaler-container">
                <div id="interactiveArea" class="hidden shadow-2xl">
                    <div id="guidesOverlay"></div>
                    <div id="barcodeArea">
                        <div id="barcodeLines"></div>
                        <div id="barcodeText">ISBN-13</div>
                    </div>
                    </div>
            </div>

        </main>
    </div>

    <canvas id="exportCanvas" class="hidden"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            // Imperative: Vertical HD Resolution
            const KINDLE_W = 1600;
            const KINDLE_H = 2560;
            
            const state = {
                mode: 'idle', // 'kindle' | 'paperback'
                frontImageB64: null,
                elements: [],
                selectedId: null,
                idCounter: 0,
                scale: 0.2, // Viewport zoom level
                paperbackCalc: null
            };

            // --- DOM ELEMENTS ---
            const ui = {
                viewport: document.getElementById('workspace-viewport'),
                scaler: document.getElementById('scaler-container'),
                canvas: document.getElementById('interactiveArea'),
                placeholder: document.getElementById('placeholder'),
                loader: document.getElementById('loader'),
                loaderText: document.getElementById('loaderText'),
                
                // Inputs
                title: document.getElementById('titleInput'),
                mood: document.getElementById('mood'),
                
                // Buttons
                btnGenerate: document.getElementById('runAgentsBtn'),
                btnAddText: document.getElementById('addTextBtn'),
                btnAddShape: document.getElementById('addShapeBtn'),
                btnInitPaperback: document.getElementById('initPaperbackBtn'),
                btnDlKindle: document.getElementById('dlKindleBtn'),
                btnDlPrint: document.getElementById('dlPrintBtn'),
                btnReset: document.getElementById('resetBtn'),
                
                // Panels
                editingTools: document.getElementById('editingTools'),
                inspector: document.getElementById('inspectorPanel'),
                textControls: document.getElementById('textControls'),
                exportKindle: document.getElementById('exportKindleSection'),
                paperbackSection: document.getElementById('paperbackSection'),
                paperbackToggles: document.getElementById('paperbackToggles'),
                
                // Info
                topInfoBar: document.getElementById('topInfoBar'),
                dimsDisplay: document.getElementById('canvasDimensionsDisplay'),
                
                // Layers
                guides: document.getElementById('guidesOverlay'),
                barcode: document.getElementById('barcodeArea'),
                toggleGuides: document.getElementById('toggleGuides'),
                toggleBarcode: document.getElementById('toggleBarcode'),
                
                // Paperback Inputs
                pageCount: document.getElementById('pageCount'),
                paperType: document.getElementById('paperType'),
                spineColor: document.getElementById('spineColor'),
                backColor: document.getElementById('backColor'),
                
                // Element Editing
                elContent: document.getElementById('elContent'),
                elColor: document.getElementById('elColor'),
                elSize: document.getElementById('elSize'),
                btnDel: document.getElementById('deleteElBtn')
            };

            // --- CORE LOGIC ---

            function resizeViewport() {
                if(state.mode === 'idle') return;
                
                // Available space
                const vw = ui.viewport.clientWidth - 60; // Padding
                const vh = ui.viewport.clientHeight - 60;
                
                // Actual dimensions of current canvas
                const cw = parseFloat(ui.canvas.style.width);
                const ch = parseFloat(ui.canvas.style.height);
                
                // Calculate Scale to Fit (contain)
                const scaleW = vw / cw;
                const scaleH = vh / ch;
                const scale = Math.min(scaleW, scaleH);
                
                state.scale = scale;
                ui.scaler.style.transform = `scale(${scale})`;
            }

            window.addEventListener('resize', resizeViewport);

            // 1. GENERATION (Kindle Mode)
            ui.btnGenerate.addEventListener('click', async () => {
                if(!ui.title.value) return alert("Inserisci almeno un titolo!");
                
                ui.loader.classList.remove('hidden');
                ui.loaderText.innerText = "GENERAZIONE IMAGE HD (1600x2560)...";
                
                // Simulate API call with Pollinations (forcing strict resolution)
                const prompt = encodeURIComponent(`${ui.title.value} ${ui.mood.value} book cover masterwork high resolution`);
                const url = `https://image.pollinations.ai/prompt/${prompt}?width=${KINDLE_W}&height=${KINDLE_H}&nologo=true&seed=${Math.floor(Math.random()*1000)}`;
                
                try {
                    const resp = await fetch(url);
                    const blob = await resp.blob();
                    const reader = new FileReader();
                    
                    reader.onloadend = () => {
                        state.frontImageB64 = reader.result;
                        initKindleMode();
                        ui.loader.classList.add('hidden');
                    };
                    reader.readAsDataURL(blob);
                    
                } catch(e) {
                    alert("Errore API Generazione");
                    ui.loader.classList.add('hidden');
                }
            });

            function initKindleMode() {
                state.mode = 'kindle';
                
                // Set DOM Dimensions explicitly to High Res
                ui.canvas.style.width = `${KINDLE_W}px`;
                ui.canvas.style.height = `${KINDLE_H}px`;
                ui.canvas.style.backgroundImage = `url(${state.frontImageB64})`;
                ui.canvas.style.backgroundColor = '#1a202c';
                
                // UI Visibility
                ui.placeholder.classList.add('hidden');
                ui.canvas.classList.remove('hidden');
                ui.editingTools.classList.remove('hidden');
                ui.exportKindle.classList.remove('hidden');
                ui.paperbackSection.classList.remove('hidden');
                ui.topInfoBar.classList.remove('hidden');
                
                // Hide Paperback stuff
                ui.paperbackToggles.classList.add('hidden');
                ui.btnDlPrint.classList.add('hidden');
                ui.guides.style.display = 'none';
                ui.barcode.style.display = 'none';
                
                // Remove spine/back elements if coming from paperback
                // (Reset canvas structure)
                
                ui.dimsDisplay.innerHTML = `KINDLE HD: <span class="text-white">${KINDLE_W}x${KINDLE_H} px</span>`;
                
                resizeViewport();
            }

            // 2. PAPERBACK MODE
            ui.btnInitPaperback.addEventListener('click', () => {
                if(!state.frontImageB64) return alert("Nessuna copertina generata!");
                
                ui.loader.classList.remove('hidden');
                ui.loaderText.innerText = "CALCOLO LAYOUT DI STAMPA...";
                
                setTimeout(() => {
                    initPaperbackMode();
                    ui.loader.classList.add('hidden');
                }, 500);
            });

            function initPaperbackMode() {
                state.mode = 'paperback';
                
                // Calculations (Using 300 DPI logic)
                const pages = parseInt(ui.pageCount.value) || 120;
                let thickness = 0.002252 * pages; // White paper inches
                if(ui.paperType.value === 'cream') thickness = 0.0025 * pages;
                
                const dpi = 300;
                
                // Fixed Height Logic: The Front Cover Height (2560px) determines the Print Height.
                // 2560px / 300dpi = 8.53 inches (Trim height + bleed)
                // We don't resize the front image. We wrap the rest around it.
                
                const spinePx = Math.ceil(thickness * dpi);
                const bleedPx = Math.ceil(0.125 * dpi);
                
                // Front width is 1600. So we assume Back width is also 1600.
                // But Front includes bleed on right? 
                // Let's assume 1600x2560 is the Full Front (Trim + Bleed).
                
                // Total Width = Back (1600) + Spine + Front (1600) -> Approximation for simplified logic
                // To be precise: Front is 1600. Back is 1600. Spine is calculated.
                
                const totalW = 1600 + spinePx + 1600;
                const totalH = 2560; // Fixed Height
                
                state.paperbackCalc = { totalW, totalH, spinePx, frontW: 1600, backW: 1600 };
                
                // Resize Canvas DOM
                ui.canvas.style.width = `${totalW}px`;
                ui.canvas.style.height = `${totalH}px`;
                
                // CREATE COMPOSITE BACKGROUND
                // Instead of using 'background-image' which repeats, we use a generated canvas dataURL
                const bgC = document.createElement('canvas');
                bgC.width = totalW; bgC.height = totalH;
                const ctx = bgC.getContext('2d');
                
                const img = new Image();
                img.onload = () => {
                    // 1. Back Color
                    ctx.fillStyle = ui.backColor.value;
                    ctx.fillRect(0, 0, 1600, totalH);
                    
                    // 2. Spine Color
                    ctx.fillStyle = ui.spineColor.value;
                    ctx.fillRect(1600, 0, spinePx, totalH);
                    
                    // 3. Front Image
                    ctx.drawImage(img, 1600 + spinePx, 0, 1600, 2560);
                    
                    ui.canvas.style.backgroundImage = `url(${bgC.toDataURL()})`;
                    
                    // Re-position existing elements?
                    // If user added text on kindle mode at x=100, now it should be x = 100 + 1600 + spinePx
                    const shiftX = 1600 + spinePx;
                    state.elements.forEach(el => {
                        // Only shift if not already shifted (simple check logic or just reset x)
                        // For this demo, we assume transition happens once. 
                        // To allow switching back and forth, we would store relative coords.
                        // Here we just shift visually.
                        const domEl = document.getElementById(el.id);
                        const currentLeft = parseFloat(domEl.style.left);
                        if(currentLeft < 1600) { // Check if it looks like it's still in old coords
                             domEl.style.left = (currentLeft + shiftX) + 'px';
                             el.x = currentLeft + shiftX;
                        }
                    });
                };
                img.src = state.frontImageB64;
                
                // UI Updates
                ui.paperbackToggles.classList.remove('hidden');
                ui.btnDlPrint.classList.remove('hidden');
                ui.exportKindle.classList.add('hidden'); // Hide Kindle export button in Print mode
                
                ui.dimsDisplay.innerHTML = `STAMPA KDP: <span class="text-white">${totalW}x${totalH} px</span>`;
                
                // Position Barcode (Bottom Left of Back Cover)
                ui.barcode.style.left = `${(1600/2) - 140}px`; // Centered on back cover roughly
                ui.barcode.style.top = `${2560 - 250}px`;
                
                resizeViewport();
            }

            // 3. SWITCHES FIX
            // We use simple CSS display toggling on existing elements. No re-rendering loops.
            ui.toggleGuides.addEventListener('change', (e) => {
                if(state.mode !== 'paperback') return;
                ui.guides.style.display = e.target.checked ? 'block' : 'none';
                if(e.target.checked) drawGuides();
            });

            ui.toggleBarcode.addEventListener('change', (e) => {
                if(state.mode !== 'paperback') return;
                ui.barcode.style.display = e.target.checked ? 'flex' : 'none';
            });

            function drawGuides() {
                const c = state.paperbackCalc;
                if(!c) return;
                
                ui.guides.innerHTML = ''; // Clear prev
                
                // Helper to create box
                const createBox = (l, t, w, h, color, label) => {
                    const d = document.createElement('div');
                    d.className = 'guide-line';
                    d.style.left = l+'px'; d.style.top = t+'px';
                    d.style.width = w+'px'; d.style.height = h+'px';
                    d.style.borderColor = color;
                    
                    if(label) {
                        const lb = document.createElement('div');
                        lb.className = 'guide-label';
                        lb.innerText = label;
                        d.appendChild(lb);
                    }
                    ui.guides.appendChild(d);
                };
                
                // Bleed Margin (0.125" = 37.5px approx @300dpi)
                const bleed = 38;
                const margin = 75; // Safe zone 0.25"
                
                // Full Trim Line
                createBox(bleed, bleed, c.totalW - (bleed*2), c.totalH - (bleed*2), 'red', 'TRIM LINE');
                
                // Spine Fold Lines
                createBox(1600, 0, c.spinePx, c.totalH, 'orange', 'SPINE');
                
                // Safe Zone Back
                createBox(bleed+margin, bleed+margin, 1600 - (bleed*2) - (margin*2), c.totalH - (bleed*2) - (margin*2), 'blue');
            }

            // 4. ELEMENT SYSTEM (Drag & Drop)
            ui.btnAddText.addEventListener('click', () => addElement('text'));
            ui.btnAddShape.addEventListener('click', () => addElement('shape'));

            function addElement(type) {
                const id = `el-${state.idCounter++}`;
                const el = document.createElement('div');
                el.id = id;
                el.className = 'draggable-item';
                
                // Initial Pos (Center of current viewport roughly)
                // For simplified logic, put at 500,500
                let startX = 500;
                let startY = 800;
                if(state.mode === 'paperback') startX += 1600; // Put on front cover

                el.style.left = startX + 'px';
                el.style.top = startY + 'px';
                
                if(type === 'text') {
                    el.innerText = 'Nuovo Testo';
                    el.style.color = '#ffffff';
                    el.style.fontSize = '80px'; // High Res Canvas needs big fonts
                    el.style.fontWeight = 'bold';
                    el.style.textShadow = '0 2px 10px rgba(0,0,0,0.5)';
                } else {
                    el.style.width = '300px';
                    el.style.height = '300px';
                    el.style.backgroundColor = '#F59E0B';
                }

                // Drag Logic
                el.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    selectElement(id);
                    startDrag(e, el);
                });

                ui.canvas.appendChild(el);
                state.elements.push({ id, type });
                selectElement(id);
            }

            function selectElement(id) {
                // Deselect others
                document.querySelectorAll('.draggable-item').forEach(e => e.classList.remove('selected'));
                state.selectedId = id;
                
                const el = document.getElementById(id);
                if(!el) return;
                
                el.classList.add('selected');
                ui.inspector.classList.remove('hidden');
                
                // Bind Inspector Inputs
                if(el.innerText) {
                    ui.textControls.classList.remove('hidden');
                    ui.elContent.value = el.innerText;
                    ui.elContent.oninput = (e) => el.innerText = e.target.value;
                    ui.elColor.value = rgbToHex(el.style.color || el.style.backgroundColor);
                    ui.elColor.oninput = (e) => {
                        if(el.innerText) el.style.color = e.target.value;
                        else el.style.backgroundColor = e.target.value;
                    };
                    ui.elSize.value = parseInt(el.style.fontSize) || 100;
                    ui.elSize.oninput = (e) => el.style.fontSize = e.target.value + 'px';
                } else {
                    ui.textControls.classList.add('hidden');
                }
            }

            let draggedEl = null;
            let offset = { x:0, y:0 };

            function startDrag(e, el) {
                draggedEl = el;
                // Calculate cursor offset relative to element
                // We must account for the Scale transform of the container
                const rect = el.getBoundingClientRect();
                // To keep it simple in scaled env: use movement deltas
            }

            window.addEventListener('mousemove', (e) => {
                if(!draggedEl) return;
                
                // Movement delta needs to be divided by scale to match canvas pixels
                const dx = e.movementX / state.scale;
                const dy = e.movementY / state.scale;
                
                const curL = parseFloat(draggedEl.style.left) || 0;
                const curT = parseFloat(draggedEl.style.top) || 0;
                
                draggedEl.style.left = (curL + dx) + 'px';
                draggedEl.style.top = (curT + dy) + 'px';
            });

            window.addEventListener('mouseup', () => draggedEl = null);

            ui.btnDel.addEventListener('click', () => {
                if(state.selectedId) {
                    const el = document.getElementById(state.selectedId);
                    if(el) el.remove();
                    ui.inspector.classList.add('hidden');
                    state.selectedId = null;
                }
            });

            // 5. EXPORT
            ui.btnDlKindle.addEventListener('click', () => downloadCanvas('kindle'));
            ui.btnDlPrint.addEventListener('click', () => downloadCanvas('print'));

            function downloadCanvas(type) {
                // Use html2canvas logic or draw to hidden canvas
                // For robust solution here, we recomposite on hidden canvas
                const c = document.getElementById('exportCanvas');
                const ctx = c.getContext('2d');
                
                const w = parseFloat(ui.canvas.style.width);
                const h = parseFloat(ui.canvas.style.height);
                
                c.width = w;
                c.height = h;
                
                // 1. Draw Background
                const bgImg = new Image();
                bgImg.crossOrigin = 'anonymous'; // Important for external images
                // Extract url from style
                const bgUrl = ui.canvas.style.backgroundImage.slice(5, -2);
                
                bgImg.onload = () => {
                    ctx.drawImage(bgImg, 0, 0, w, h);
                    
                    // 2. Draw Elements
                    // (Simple iteration over DOM elements logic)
                    const items = ui.canvas.querySelectorAll('.draggable-item');
                    items.forEach(item => {
                        const x = parseFloat(item.style.left);
                        const y = parseFloat(item.style.top);
                        
                        if(item.innerText) {
                            const size = window.getComputedStyle(item).fontSize;
                            const color = window.getComputedStyle(item).color;
                            const weight = window.getComputedStyle(item).fontWeight;
                            ctx.font = `${weight} ${size} Inter`;
                            ctx.fillStyle = color;
                            ctx.fillText(item.innerText, x, y + parseFloat(size)); // Baseline adjust
                        } else {
                            const bw = parseFloat(item.style.width);
                            const bh = parseFloat(item.style.height);
                            ctx.fillStyle = item.style.backgroundColor;
                            ctx.fillRect(x, y, bw, bh);
                        }
                    });
                    
                    // 3. Download
                    const a = document.createElement('a');
                    a.download = `Cover-${type}.jpg`;
                    a.href = c.toDataURL('image/jpeg', 0.9);
                    a.click();
                };
                bgImg.src = bgUrl;
            }

            // Utils
            function rgbToHex(col) {
                if(col.charAt(0)=='#') return col;
                // Basic parser for rgb()
                const rgb = col.match(/\d+/g);
                if(!rgb) return '#ffffff';
                return "#" + ((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1);
            }
            
            ui.btnReset.addEventListener('click', () => location.reload());
        });
    </script>
</body>
</html>