<!DOCTYPE html>
<html lang="it">
<head>
    <script src="https://js.stripe.com/v3/"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDP Cover Designer Pro - Interactive Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Anton&family=Bebas+Neue&family=Bodoni+Moda&family=Cabin&family=Cinzel&family=Cormorant+Garamond&family=Dancing+Script&family=Great+Vibes&family=Inter:wght@400;700;900&family=Lato&family=Libre+Baskerville&family=Lobster&family=Lora&family=Merriweather&family=Montserrat:wght@400;700;900&family=Nunito&family=Open+Sans&family=Oswald&family=Pacifico&family=Playfair+Display:wght@400;700;900&family=Poppins&family=Quicksand&family=Raleway&family=Roboto&family=Roboto+Condensed&family=Satisfy&family=Source+Sans+Pro&family=Ubuntu&family=Work+Sans&family=Creepster&family=Nosifer&family=Rye&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; background-color: #0f172a; color: white; } 
        
        .banana-loader {
            width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #FFD700;
            border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }

        /* FIX: Canvas Proporzionato e visibile senza scroll forzato */
        #interactiveArea {
            position: relative;
            overflow: hidden;
            user-select: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            background-color: #1e293b;
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            margin: 0 auto;
            max-width: 100%;
            /* Altezza calcolata per restare dentro la viewport */
            height: calc(100vh - 220px); 
            aspect-ratio: 2 / 3;
            border: 1px solid #334155;
        }
        
        .draggable-item {
            position: absolute;
            cursor: move;
            z-index: 200;
            white-space: nowrap;
            line-height: 1.1;
            padding: 6px;
            user-select: none;
            transition: box-shadow 0.2s;
        }

        .draggable-item:hover { outline: 1px dashed rgba(255,255,255,0.6); }
        .draggable-item.selected { outline: 2px solid #F59E0B; background: rgba(245, 158, 11, 0.15); border-radius: 4px; }
    </style>
</head>
<body class="selection:bg-yellow-500 selection:text-gray-900">

    <nav class="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-50">
        <div class="w-full px-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-layer-group text-yellow-400 text-2xl"></i>
                <h1 class="text-xl font-black bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-orange-500 uppercase italic">KDP Designer Studio</h1>
            </div>
            <button id="resetBtn" class="bg-red-600 hover:bg-red-500 px-4 py-1.5 rounded-full text-[10px] font-bold uppercase transition-all shadow-lg active:scale-95">
                <i class="fa-solid fa-rotate-right mr-1"></i> Reset Progetto
            </button>
        </div>
    </nav>

    <div class="w-full px-6 py-6 grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
        
        <div class="lg:col-span-3 space-y-6 lg:sticky lg:top-24 lg:max-h-[calc(100vh-8rem)] lg:overflow-y-auto custom-scrollbar pr-2">
            
            <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 border-l-4 border-l-fuchsia-500 shadow-2xl">
                <h2 class="text-xs font-black mb-5 flex items-center gap-2 text-fuchsia-400 uppercase tracking-widest">
                    <i class="fa-solid fa-brain"></i> 1. Generazione Artwork
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold ml-1">Titolo del Libro</label>
                        <input type="text" id="titleInput" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm focus:border-fuchsia-500 outline-none transition-colors" placeholder="Es: Il Mistero del Castello">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold ml-1">Tema / Atmosfera</label>
                        <textarea id="mood" rows="2" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm focus:border-fuchsia-500 outline-none transition-colors" placeholder="Es: Bosco nebbioso, stile fantasy..."></textarea>
                    </div>
                    <button id="runAgentsBtn" class="w-full bg-gradient-to-br from-fuchsia-600 to-purple-700 hover:from-fuchsia-500 hover:to-purple-600 py-4 rounded-xl font-black text-xs shadow-xl transition-all uppercase tracking-tighter active:scale-95">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Genera Copertina
                    </button>
                    
                    <div id="modificationArea" class="hidden mt-4 pt-4 border-t border-gray-700 animate-fade-in">
                        <label class="text-[10px] text-yellow-500 uppercase font-black mb-2 block">Modifiche Avanzate</label>
                        <textarea id="modificationPrompt" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-xs mb-3" placeholder="Aggiungi dettagli..."></textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="applyMod" class="bg-purple-600 hover:bg-purple-500 text-[9px] py-2 rounded font-bold uppercase">Applica</button>
                            <button id="undoMod" class="bg-gray-600 hover:bg-gray-500 text-[9px] py-2 rounded font-bold uppercase">Annulla</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="designStudio" class="hidden bg-gray-800 p-5 rounded-xl border border-gray-700 border-l-4 border-l-yellow-500 shadow-2xl">
                <h2 class="text-xs font-black mb-5 text-yellow-500 uppercase tracking-widest">
                    <i class="fa-solid fa-font mr-2"></i> 2. Personalizzazione
                </h2>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button id="addTextBtn" class="bg-gray-700 hover:bg-gray-600 py-3 rounded-lg text-[10px] font-bold border border-gray-600 uppercase">
                        <i class="fa-solid fa-plus mr-1 text-yellow-500"></i> Testo
                    </button>
                    <button id="addShapeBtn" class="bg-gray-700 hover:bg-gray-600 py-3 rounded-lg text-[10px] font-bold border border-gray-600 uppercase">
                        <i class="fa-solid fa-square mr-1 text-orange-500"></i> Forma
                    </button>
                </div>

                <div id="inspector" class="hidden space-y-4 bg-gray-900/50 p-4 rounded-xl border border-gray-700 animate-fade-in">
                    <div>
                        <label class="text-[9px] text-gray-500 font-bold uppercase">Contenuto</label>
                        <input type="text" id="elText" class="w-full bg-gray-800 border-gray-700 rounded p-2 text-xs outline-none focus:border-yellow-500">
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-[9px] text-gray-500 font-bold uppercase block mb-1">Colore</label>
                            <input type="color" id="elColor" class="w-full h-8 bg-transparent border-0 cursor-pointer">
                        </div>
                        <div class="flex-[2]">
                            <label class="text-[9px] text-gray-500 font-bold uppercase block mb-1">Dimensione</label>
                            <input type="range" id="elSize" min="10" max="250" class="w-full accent-yellow-500">
                        </div>
                    </div>
                    <button id="deleteEl" class="w-full text-red-500 hover:text-red-400 text-[9px] font-black uppercase py-2 border border-red-900/30 rounded mt-2 transition-colors">
                        <i class="fa-solid fa-trash mr-1"></i> Elimina Elemento
                    </button>
                </div>
                <div id="inspectorHint" class="text-[10px] text-gray-500 italic text-center py-4 border border-dashed border-gray-700 rounded-xl">
                    Seleziona un elemento sul canvas per modificarlo
                </div>
            </div>

            <div id="exportSection" class="hidden bg-gray-800 p-5 rounded-xl border border-gray-700 border-l-4 border-l-green-500 shadow-2xl">
                <h2 class="text-xs font-black mb-4 text-green-400 uppercase tracking-widest">
                    <i class="fa-solid fa-download mr-2"></i> 3. Esporta Progetto
                </h2>
                <button id="downloadBtn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 py-4 rounded-xl font-black text-xs shadow-xl transition-all transform hover:-translate-y-1 active:scale-95">
                    <i class="fa-brands fa-amazon mr-2 text-lg"></i> SCARICA COVER KINDLE HD
                </button>
                <p class="text-[9px] text-gray-500 mt-3 text-center italic">File ottimizzato per Amazon KDP (JPG 300 DPI)</p>
            </div>
        </div>

        <div class="lg:col-span-9 flex flex-col items-center">
            <div id="previewContainer" class="w-full bg-gray-800/30 rounded-3xl border-2 border-dashed border-gray-700 min-h-[600px] flex items-center justify-center relative overflow-hidden p-4 backdrop-blur-sm">
                
                <div id="loader" class="hidden absolute inset-0 bg-gray-900/90 z-[100] flex flex-col items-center justify-center backdrop-blur-xl">
                    <div class="banana-loader"></div>
                    <p class="text-yellow-400 mt-6 font-black animate-pulse uppercase tracking-[0.3em] text-xs">Elaborazione Grafica...</p>
                </div>

                <div id="placeholder" class="text-gray-600 flex flex-col items-center transition-opacity duration-500">
                    <i class="fa-solid fa-palette text-9xl opacity-10 mb-6"></i>
                    <p class="font-black text-xl opacity-20 uppercase tracking-tighter">Il tuo Workspace è pronto</p>
                    <p class="text-xs opacity-20 mt-2">Inizia compilando i dati a sinistra</p>
                </div>

                <div id="interactiveArea" class="hidden shadow-[0_0_100px_rgba(0,0,0,0.5)]">
                    </div>
            </div>
            
            <div class="mt-6 flex items-center gap-6 opacity-40">
                <div class="flex items-center gap-2 text-[10px] uppercase font-bold"><i class="fa-solid fa-expand text-yellow-500"></i> Risoluzione HD</div>
                <div class="flex items-center gap-2 text-[10px] uppercase font-bold"><i class="fa-solid fa-shield-halved text-green-500"></i> Amazon Ready</div>
                <div class="flex items-center gap-2 text-[10px] uppercase font-bold"><i class="fa-solid fa-layer-group text-blue-500"></i> Layer Interattivi</div>
            </div>
        </div>
    </div>

    <canvas id="finalExportCanvas" class="hidden"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                elements: [],
                selectedId: null,
                idCounter: 0,
                bgB64: null,
                visualScale: 1
            };

            const els = {
                title: document.getElementById('titleInput'),
                mood: document.getElementById('mood'),
                btnGen: document.getElementById('runAgentsBtn'),
                area: document.getElementById('interactiveArea'),
                loader: document.getElementById('loader'),
                placeholder: document.getElementById('placeholder'),
                designStudio: document.getElementById('designStudio'),
                exportSection: document.getElementById('exportSection'),
                inspector: document.getElementById('inspector'),
                inspectorHint: document.getElementById('inspectorHint'),
                elText: document.getElementById('elText'),
                elColor: document.getElementById('elColor'),
                elSize: document.getElementById('elSize'),
                downloadBtn: document.getElementById('downloadBtn'),
                resetBtn: document.getElementById('resetBtn')
            };

            // --- 1. MOTORE DI GENERAZIONE IA ---
            els.btnGen.addEventListener('click', async () => {
                if(!els.title.value) return alert("Inserisci il titolo del libro!");
                
                els.loader.classList.remove('hidden');
                els.placeholder.style.opacity = '0';

                const prompt = `Vertical high-quality book cover for "${els.title.value}", theme: ${els.mood.value}, professional typography, cinematic lighting, 300dpi style`;
                const seed = Math.floor(Math.random() * 1000000);
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1000&height=1500&nologo=true&seed=${seed}`;

                try {
                    const res = await fetch(url);
                    const blob = await res.blob();
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        state.bgB64 = reader.result;
                        els.area.style.backgroundImage = `url(${reader.result})`;
                        
                        // Calcolo scaling per adattarsi allo schermo
                        const vh = window.innerHeight;
                        const targetHeight = vh - 220;
                        const targetWidth = (targetHeight * 2) / 3;
                        
                        els.area.style.width = `${targetWidth}px`;
                        els.area.style.height = `${targetHeight}px`;
                        state.visualScale = 1500 / targetHeight; // Rapporto tra HD e visuale
                        
                        els.area.classList.remove('hidden');
                        els.placeholder.classList.add('hidden');
                        els.loader.classList.add('hidden');
                        els.designStudio.classList.remove('hidden');
                        els.exportSection.classList.remove('hidden');
                        document.getElementById('modificationArea').classList.remove('hidden');
                    };
                    reader.readAsDataURL(blob);
                } catch (e) {
                    alert("Impossibile connettersi al generatore. Riprova.");
                    els.loader.classList.add('hidden');
                }
            });

            // --- 2. GESTIONE LAYER E EDITOR ---
            function selectElement(id) {
                state.selectedId = id;
                state.elements.forEach(e => {
                    const dom = document.getElementById(e.id);
                    if(dom) dom.classList.toggle('selected', e.id === id);
                });
                
                els.inspector.classList.remove('hidden');
                els.inspectorHint.classList.add('hidden');
                
                const el = state.elements.find(e => e.id === id);
                if(el.type === 'text') {
                    els.elText.classList.remove('hidden');
                    els.elText.value = el.content;
                } else {
                    els.elText.classList.add('hidden');
                }
                els.elColor.value = el.color;
                els.elSize.value = parseInt(el.size);
            }

            function addElement(type) {
                const id = `el_${state.idCounter++}`;
                const el = {
                    id, type,
                    content: type === 'text' ? 'TITOLO LIBRO' : '',
                    x: 50, y: 100,
                    color: '#ffffff',
                    size: '40px'
                };
                state.elements.push(el);
                
                const div = document.createElement('div');
                div.id = id;
                div.className = 'draggable-item';
                if(type === 'text') {
                    div.innerText = el.content;
                    div.style.fontFamily = "'Montserrat', sans-serif";
                    div.style.fontWeight = '900';
                    div.style.textShadow = '0 2px 10px rgba(0,0,0,0.5)';
                } else {
                    div.style.width = '100px'; div.style.height = '100px';
                    div.style.backgroundColor = el.color;
                    div.style.opacity = '0.5';
                }
                
                div.style.left = '50px'; div.style.top = '100px';
                div.style.color = el.color;
                div.style.fontSize = el.size;

                div.addEventListener('mousedown', initDrag);
                div.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectElement(id);
                });

                els.area.appendChild(div);
                selectElement(id);
            }

            document.getElementById('addTextBtn').addEventListener('click', () => addElement('text'));
            document.getElementById('addShapeBtn').addEventListener('click', () => addElement('shape'));

            // --- 3. MOTORE DRAG & DROP ---
            let activeDrag = null;
            let startPos = { x: 0, y: 0 };

            function initDrag(e) {
                activeDrag = e.target;
                const rect = activeDrag.getBoundingClientRect();
                startPos.x = e.clientX - rect.left;
                startPos.y = e.clientY - rect.top;
                selectElement(activeDrag.id);
            }

            document.addEventListener('mousemove', (e) => {
                if(!activeDrag) return;
                const areaRect = els.area.getBoundingClientRect();
                let x = e.clientX - areaRect.left - startPos.x;
                let y = e.clientY - areaRect.top - startPos.y;
                
                // Limiti
                x = Math.max(0, Math.min(x, areaRect.width - activeDrag.offsetWidth));
                y = Math.max(0, Math.min(y, areaRect.height - activeDrag.offsetHeight));

                activeDrag.style.left = `${x}px`;
                activeDrag.style.top = `${y}px`;
                
                const el = state.elements.find(i => i.id === activeDrag.id);
                el.x = x; el.y = y;
            });

            document.addEventListener('mouseup', () => { activeDrag = null; });

            // --- 4. SINCRONIZZAZIONE INSPECTOR ---
            els.elText.addEventListener('input', (e) => {
                if(!state.selectedId) return;
                const el = state.elements.find(i => i.id === state.selectedId);
                el.content = e.target.value;
                document.getElementById(el.id).innerText = e.target.value;
            });

            els.elColor.addEventListener('input', (e) => {
                if(!state.selectedId) return;
                const el = state.elements.find(i => i.id === state.selectedId);
                el.color = e.target.value;
                const dom = document.getElementById(el.id);
                if(el.type === 'text') dom.style.color = e.target.value;
                else dom.style.backgroundColor = e.target.value;
            });

            els.elSize.addEventListener('input', (e) => {
                if(!state.selectedId) return;
                const el = state.elements.find(i => i.id === state.selectedId);
                el.size = `${e.target.value}px`;
                const dom = document.getElementById(el.id);
                if(el.type === 'text') dom.style.fontSize = el.size;
                else {
                    dom.style.width = el.size; dom.style.height = el.size;
                }
            });

            document.getElementById('deleteEl').addEventListener('click', () => {
                if(!state.selectedId) return;
                document.getElementById(state.selectedId).remove();
                state.elements = state.elements.filter(i => i.id !== state.selectedId);
                state.selectedId = null;
                els.inspector.classList.add('hidden');
                els.inspectorHint.classList.remove('hidden');
            });

            // --- 5. SISTEMA DI EXPORT HD (RENDERING) ---
            els.downloadBtn.addEventListener('click', () => {
                const canvas = document.getElementById('finalExportCanvas');
                const ctx = canvas.getContext('2d');
                
                // Amazon Kindle HD Standard (1600 x 2400)
                canvas.width = 1600;
                canvas.height = 2400;

                els.loader.classList.remove('hidden');
                els.loader.querySelector('p').innerText = "Rendering HD...";

                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => {
                    // Sfondo
                    ctx.drawImage(img, 0, 0, 1600, 2400);
                    
                    // Rapporto tra dimensione visuale attuale e HD
                    const visualWidth = parseFloat(els.area.style.width);
                    const scale = 1600 / visualWidth;

                    // Layer
                    state.elements.forEach(el => {
                        ctx.save();
                        ctx.fillStyle = el.color;
                        const fontSizeHD = parseInt(el.size) * scale;
                        ctx.font = `900 ${fontSizeHD}px Montserrat, sans-serif`;
                        
                        if(el.type === 'text') {
                            // Aggiungiamo un'ombra leggera per leggibilità
                            ctx.shadowColor = 'rgba(0,0,0,0.5)';
                            ctx.shadowBlur = 15;
                            ctx.fillText(el.content, el.x * scale, (el.y * scale) + fontSizeHD);
                        } else {
                            ctx.globalAlpha = 0.5;
                            ctx.fillRect(el.x * scale, el.y * scale, fontSizeHD, fontSizeHD);
                        }
                        ctx.restore();
                    });

                    // Download
                    const link = document.createElement('a');
                    link.download = `kdp-cover-${Date.now()}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                    
                    els.loader.classList.add('hidden');
                    els.loader.querySelector('p').innerText = "Elaborazione Grafica...";
                };
                img.src = state.bgB64;
            });

            els.resetBtn.addEventListener('click', () => {
                if(confirm("Attenzione: perderai tutte le modifiche correnti. Vuoi continuare?")) {
                    location.reload();
                }
            });
        });
    </script>
</body>
</html>