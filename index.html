<!DOCTYPE html>
<html lang="it">
<head>
<script src="https://js.stripe.com/v3/"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDP Cover Designer Pro - Interactive Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Anton&family=Bebas+Neue&family=Bodoni+Moda&family=Cabin&family=Cinzel&family=Cormorant+Garamond&family=Dancing+Script&family=Great+Vibes&family=Inter:wght@400;700;900&family=Lato&family=Libre+Baskerville&family=Lobster&family=Lora&family=Merriweather&family=Montserrat:wght@400;700;900&family=Nunito&family=Open+Sans&family=Oswald&family=Pacifico&family=Playfair+Display:wght@400;700;900&family=Poppins&family=Quicksand&family=Raleway&family=Roboto&family=Roboto+Condensed&family=Satisfy&family=Source+Sans+Pro&family=Ubuntu&family=Work+Sans&family=Creepster&family=Nosifer&family=Rye&display=swap" rel="stylesheet">

    <style>
        /* BLOCCO SCROLL PAGINA GLOBALE */
        body { font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        
        .banana-loader {
            width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #FFD700;
            border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* UI Elements */
        optgroup { color: #F59E0B; font-weight: 700; background-color: #111827; }
        option { color: white; background-color: #1F2937; font-weight: normal; }

        .text-shadow-black { text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8); }
        .text-shadow-strong { text-shadow: 2px 2px 4px #000000, 0 0 4px #000000; }

        /* INTERACTIVE CANVAS STYLES */
        #interactiveArea {
            position: relative;
            overflow: hidden;
            user-select: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: width 0.3s ease, height 0.3s ease;
            background-color: #1a202c;
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            /* Centrato nel flex container */
        }
        
        .draggable-item {
            position: absolute;
            cursor: move;
            border: none !important; 
            outline: none !important;
            background: transparent; 
            box-shadow: none !important;
            padding: 4px;
            min-width: 20px; 
            min-height: 1.2em;
            display: inline-block;
            white-space: nowrap;
            transform-origin: center center;
            z-index: 200; 
            line-height: 1.1; 
        }
        
        .draggable-item:empty { width: 50px; height: 30px; display: inline-block; }
        .draggable-item:hover, .draggable-item.selected, .draggable-item:focus { border: 1px dashed rgba(255, 255, 255, 0.5) !important; outline: none !important; }
        
        /* Input Range Custom */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #F59E0B; cursor: pointer; margin-top: -5px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #4B5563; border-radius: 2px; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .style-btn.active { background-color: #F59E0B; color: #111827; border-color: #F59E0B; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        
        #selectionBox { position: absolute; border: 2px dashed #ef4444; background-color: rgba(239, 68, 68, 0.2); pointer-events: none; z-index: 100; display: none; }

        #barcodeArea { position: absolute; width: 90px; height: 55px; background-color: #ffffff; align-items: center; justify-content: center; z-index: 1000; pointer-events: auto; box-shadow: 0 0 5px rgba(0,0,0,0.3); border: 4px solid white; flex-direction: column; }
        #barcodeLines { width: 100%; height: 80%; background-image: repeating-linear-gradient(90deg, #000 0px, #000 2px, #fff 2px, #fff 3px, #000 3px, #000 5px, #fff 5px, #fff 6px, #000 6px, #000 9px, #fff 9px, #fff 11px ); }
        #barcodeText { width: 100%; text-align: center; font-family: 'Courier New', monospace; font-size: 8px; color: black; height: 20%; line-height: 10px; background: white; font-weight: bold; }

        #guidesOverlay { position: absolute; inset: 0; pointer-events: none; z-index: 990; }
        .kdp-bleed-zone { position: absolute; background-color: rgba(236, 72, 153, 0.3); z-index: 991; }
        .kdp-safe-zone { position: absolute; border: 1px dashed #ef4444; z-index: 992; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1); }
        .kdp-spine-fold { position: absolute; border-left: 1px dashed #ef4444; border-right: 1px dashed #ef4444; height: 100%; background-color: rgba(0, 0, 0, 0.1); z-index: 991; }
        .kdp-trim-line { position: absolute; border: 1px dashed #000; pointer-events: none; z-index: 993; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen selection:bg-yellow-500 selection:text-gray-900 overflow-hidden flex flex-col">

    <nav class="bg-gray-800 border-b border-gray-700 h-16 shrink-0 z-50 shadow-lg flex items-center px-6 justify-between">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-layer-group text-yellow-400 text-2xl"></i>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-orange-500">KDP Interactive Studio</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-xs font-mono text-gray-400 bg-gray-700 px-3 py-1 rounded-full">
                <i class="fa-solid fa-pen-ruler mr-2"></i>Design Mode
            </div>
            <button id="resetBtn" type="button" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold transition-colors flex items-center gap-2 cursor-pointer" title="Resetta tutto">
                <i class="fa-solid fa-rotate-right"></i> Reset
            </button>
        </div>
    </nav>

    <div class="w-full px-6 py-4 grid grid-cols-12 gap-6 h-[calc(100vh-4rem)] overflow-hidden">
        
        <div class="col-span-3 flex flex-col gap-4 h-full overflow-y-auto custom-scrollbar pb-4">
            
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 border-l-4 border-l-fuchsia-300 shrink-0">
                <h2 class="text-sm font-bold mb-3 flex items-center gap-2 text-fuchsia-200">
                    <i class="fa-solid fa-brain"></i> 1. Generazione
                </h2>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold">Titolo</label>
                        <input type="text" id="titleInput" class="w-full bg-gray-900 border border-gray-600 rounded p-2 mt-1 text-xs text-white focus:border-yellow-500 outline-none font-bold" placeholder="Es. Pinocchio">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold">Tema</label>
                        <textarea id="mood" rows="2" class="w-full bg-gray-900 border border-gray-600 rounded p-2 mt-1 text-xs text-white focus:border-yellow-500 outline-none" placeholder="Descrizione..."></textarea>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold">Stile</label>
                        <select id="styleGenre" class="w-full bg-gray-900 border border-gray-600 rounded p-2 mt-1 text-xs text-white focus:border-yellow-500 outline-none">
                            <option value="none">Nessuno</option>
                            <option value="fantasy">Fantasy</option>
                            <option value="realistic">Realistico</option>
                            <option value="vintage">Vintage</option>
                            <option value="cinematic">Cinematico</option>
                        </select>
                    </div>
                    
                    <button type="button" id="runAgentsBtn" class="w-full bg-gradient-to-r from-violet-600 to-blue-600 hover:from-violet-500 hover:to-blue-500 text-white text-xs font-bold py-2 rounded shadow mt-1 transition-all">
                        <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Genera
                    </button>

                    <div id="modificationArea" class="hidden pt-2 border-t border-gray-700 animate-fade-in">
                        <label class="text-[10px] text-yellow-100 font-bold block mb-1">Edit</label>
                        <textarea id="modificationPrompt" rows="1" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white mb-2" placeholder="Es. PiÃ¹ scuro..."></textarea>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button id="modifyArtworkBtn" class="bg-purple-600 hover:bg-purple-500 text-white text-[10px] py-1 rounded">Applica</button>
                            <button id="undoBtn" class="bg-gray-600 hover:bg-gray-500 text-white text-[10px] py-1 rounded">Annulla</button>
                        </div>
                        <button id="toggleSelectModeBtn" class="w-full bg-pink-600 hover:bg-pink-500 text-white text-[10px] py-1 rounded">
                            Inpainting (Seleziona Area)
                        </button>
                        <div id="selectionControls" class="hidden mt-2">
                             <textarea id="selectivePrompt" rows="1" class="w-full bg-gray-900 border border-red-500/50 rounded p-1 text-xs mb-1" placeholder="Cosa cambiare qui?"></textarea>
                             <div class="flex gap-1">
                                <button id="applySelectiveBtn" class="flex-1 bg-red-600 text-white text-[10px] py-1 rounded">Esegui</button>
                                <button id="cancelSelectBtn" class="flex-1 bg-gray-600 text-white text-[10px] py-1 rounded">Esci</button>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="designStudio" class="hidden bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 border-l-4 border-l-yellow-500 shrink-0">
                <h2 class="text-sm font-bold mb-3 flex items-center gap-2 text-yellow-400">
                    <i class="fa-solid fa-layer-group"></i> 2. Studio
                </h2>
                
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button id="addGenericTextBtn" class="bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 rounded p-2 text-xs font-bold flex items-center justify-center gap-1">
                        <i class="fa-solid fa-font"></i> Testo
                    </button>
                    <div class="flex gap-1">
                        <button id="addRectBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 rounded flex items-center justify-center"><i class="fa-regular fa-square text-xs text-orange-400"></i></button>
                        <button id="addCircleBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 rounded flex items-center justify-center"><i class="fa-regular fa-circle text-xs text-orange-400"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-1 mb-3">
                    <button id="addFlagBtn" class="bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 rounded py-1 text-[10px]">Flag</button>
                    <button id="addBulletBtn" class="bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 rounded py-1 text-[10px]">List</button>
                    <button id="addBadgeBtn" class="bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 rounded py-1 text-[10px]">Badge</button>
                </div>

                <div id="inspectorPlaceholder" class="text-center py-4 text-gray-500 text-xs italic border border-dashed border-gray-700 rounded">
                    Seleziona un elemento
                </div>

                <div id="textInspector" class="hidden space-y-2 bg-gray-900/50 p-2 rounded border border-gray-600">
                    <div id="textSpecificControls" class="hidden space-y-2">
                        <input type="text" id="selectedTextInput" class="w-full bg-gray-800 border-gray-600 rounded p-1 text-xs text-white">
                        <select id="fontSelector" class="w-full bg-gray-800 border-gray-600 rounded p-1 text-xs text-white">
                            <option value="'Inter', sans-serif">Inter</option>
                            <option value="'Cinzel', serif">Cinzel</option>
                            <option value="'Playfair Display', serif">Playfair</option>
                            <option value="'Bebas Neue', cursive">Bebas Neue</option>
                        </select>
                        <div class="flex gap-1">
                            <button id="boldBtn" class="flex-1 bg-gray-800 border-gray-600 rounded p-1 text-[10px] text-white"><i class="fa-solid fa-bold"></i></button>
                            <button id="italicBtn" class="flex-1 bg-gray-800 border-gray-600 rounded p-1 text-[10px] text-white"><i class="fa-solid fa-italic"></i></button>
                            <button id="aiStyleBtn" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white text-[9px] rounded">AI Style</button>
                        </div>
                        <div class="flex gap-1">
                            <button id="alignLeftBtn" class="flex-1 bg-gray-800 border-gray-600 rounded p-1 text-[10px] text-white"><i class="fa-solid fa-align-left"></i></button>
                            <button id="alignCenterBtn" class="flex-1 bg-gray-800 border-gray-600 rounded p-1 text-[10px] text-white"><i class="fa-solid fa-align-center"></i></button>
                            <button id="alignRightBtn" class="flex-1 bg-gray-800 border-gray-600 rounded p-1 text-[10px] text-white"><i class="fa-solid fa-align-right"></i></button>
                        </div>
                    </div>
                    
                    <div id="shapeSpecificControls" class="hidden space-y-1">
                        <div class="flex justify-between text-[10px] items-center"><label>W</label><input type="range" id="shapeWidthInput" min="10" max="500" class="w-20"></div>
                        <div class="flex justify-between text-[10px] items-center"><label>H</label><input type="range" id="shapeHeightInput" min="10" max="500" class="w-20"></div>
                        <div id="borderRadiusControl" class="flex justify-between text-[10px] items-center"><label>R</label><input type="range" id="shapeRadiusInput" min="0" max="100" class="w-20"></div>
                    </div>

                    <div class="flex justify-between items-center text-[10px]">
                        <label>Colore</label><input type="color" id="colorPicker" class="bg-transparent w-5 h-5 border-0 p-0">
                    </div>
                    <div id="textSizeControl" class="hidden flex justify-between items-center text-[10px]">
                        <label>Size</label><input type="range" id="sizeInput" min="5" max="200" class="w-20">
                    </div>
                    <div class="flex justify-between items-center text-[10px]">
                        <label>Ruota</label><input type="range" id="rotationInput" min="-180" max="180" class="w-20">
                    </div>
                    
                    <div id="imageInspector" class="hidden space-y-2">
                        <div class="flex justify-between items-center text-[10px]"><label>Size</label><input type="range" id="imgSizeInput" min="10" max="800" class="w-20"></div>
                        <div class="flex justify-between items-center text-[10px]"><label>Rot</label><input type="range" id="imgRotationInput" min="-180" max="180" class="w-20"></div>
                    </div>

                    <div class="flex gap-1 mt-2">
                        <button id="centerElementBtn" class="flex-1 bg-gray-700 text-[10px] py-1 rounded hover:bg-gray-600">Centra</button>
                        <button id="deleteElementBtn" class="flex-1 bg-red-900/80 text-red-200 text-[10px] py-1 rounded hover:bg-red-800">Elimina</button>
                        <button id="deleteImageBtn" class="hidden flex-1 bg-red-900/80 text-red-200 text-[10px] py-1 rounded hover:bg-red-800">Elimina</button>
                    </div>
                    
                    <div class="hidden">
                        <input id="opacityInput" type="range" value="1"><span id="opacityValue"></span>
                        <input id="spacingInput"><span id="spacingValue"></span>
                        <input id="strokeColorPicker"><input id="strokeWidthInput">
                        <input id="shadowColorPicker"><input id="shadowBlurInput"><input id="shadowOffsetInput"><input id="shadowAngleInput">
                        <span id="angleValue"></span><span id="offsetValue"></span><span id="rotationValue"></span>
                        <span id="shapeWidthDisplay"></span><span id="shapeHeightDisplay"></span><span id="shapeRadiusDisplay"></span>
                        <span id="sizeValueDisplay"></span><span id="imgSizeValue"></span><span id="imgRotationValue"></span>
                        <button id="resetRotationBtn"></button><button id="rotateNegative90Btn"></button>
                        <div id="textStrokeControl"></div><div id="textSpacingControl"></div><div id="opacityControl"></div>
                    </div>
                </div>
            </div>

            <div id="exportSection" class="hidden bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 border-l-4 border-l-green-500 shrink-0">
                <h2 class="text-sm font-bold mb-2 flex items-center gap-2 text-green-400">
                    <i class="fa-solid fa-file-export"></i> 3. Esporta
                </h2>
                <button id="downloadKindleBtn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white text-xs font-bold py-3 rounded shadow transition-transform transform hover:scale-105">
                    <i class="fa-brands fa-amazon mr-1"></i> Scarica Cover
                </button>
            </div>

            <div id="printSection" class="hidden bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 border-l-4 border-l-orange-500 shrink-0">
                <h2 class="text-sm font-bold mb-2 flex items-center gap-2 text-orange-400">
                    <i class="fa-solid fa-print"></i> 4. Paperback
                </h2>
                
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div><label class="text-[10px] text-gray-400 uppercase font-bold">Trim</label><select id="trimSizeInput" class="w-full bg-gray-900 border border-orange-200 rounded p-1 text-xs"><option value="5x8">5x8</option><option value="6x9">6x9</option><option value="8.5x11" selected>8.5x11</option></select></div>
                    <div><label class="text-[10px] text-gray-400 uppercase font-bold">Pagine</label><input type="number" id="pageCountInput" value="100" class="w-full bg-gray-900 border border-orange-200 rounded p-1 text-xs"></div>
                </div>
                <div class="mb-2"><label class="text-[10px] text-gray-400 uppercase font-bold">Carta</label><select id="paperTypeInput" class="w-full bg-gray-900 border border-orange-200 rounded p-1 text-xs"><option value="white">Bianca</option><option value="cream">Crema</option><option value="color">Colore</option></select></div>
                
                <button id="initPaperbackBtn" class="w-full bg-orange-600 hover:bg-orange-500 text-white text-xs font-bold py-2 rounded shadow mb-2">Crea Layout KDP</button>
                
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div><label class="text-[10px] text-gray-400">Spina</label><input type="color" id="spineColorInput" class="w-full h-5 rounded cursor-pointer" value="#F59E0B"></div>
                    <div><label class="text-[10px] text-gray-400">Retro</label><input type="color" id="backColorInput" class="w-full h-5 rounded cursor-pointer" value="#1a202c"></div>
                </div>

                <div id="spineTools" class="hidden space-y-2 border-t border-gray-700 pt-2">
                    <div class="flex gap-1"><input id="spineTextInput" class="flex-1 bg-gray-900 border border-gray-600 rounded text-xs px-1" placeholder="Testo Spina"><button id="addSpineTextBtn" class="bg-gray-600 text-white px-2 rounded text-xs">+</button></div>
                    <button id="centerSpineTextBtn" class="w-full bg-gray-700 text-[9px] py-1 rounded">Centra Spina</button>
                    
                    <div class="flex gap-1"><input id="backTextInput" class="flex-1 bg-gray-900 border border-gray-600 rounded text-xs px-1" placeholder="Testo Retro"><button id="addBackTextBtn" class="bg-gray-600 text-white px-2 rounded text-xs">+</button></div>
                    <button id="centerBackTextBtn" class="w-full bg-gray-700 text-[9px] py-1 rounded">Centra Retro</button>
                    
                    <label class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white text-[10px] py-1 rounded block text-center">
                        + Img Retro <input type="file" id="addBackImageInput" class="hidden" accept="image/*">
                    </label>
                </div>

                <div class="mt-2 text-[9px] text-gray-400 bg-gray-900 p-1 rounded">
                    <div class="flex justify-between"><span>Spina:</span> <span id="spineWidthDisplay" class="text-white">0.23"</span></div>
                    <div class="flex justify-between items-center mt-1"><span>Barcode</span><input type="checkbox" id="toggleBarcode"></div>
                    <div class="flex justify-between items-center mt-1"><span>Guide</span><input type="checkbox" id="toggleGuides"></div>
                </div>
                
                <button id="downloadPrintBtn" class="hidden w-full bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 rounded shadow mt-2">Scarica PDF Stampa</button>
                
                <input type="file" id="styleRefInput" class="hidden"> <div id="styleRefPreview" class="hidden"> <img id="styleRefImg"> <button id="clearStyleRef"></button> </div> <input type="file" id="importFrontInput" class="hidden"> <div id="paperbackTools" class="hidden"></div> <div id="totalResDisplay" class="hidden"></div>
            </div>
        </div>

        <div class="col-span-9 h-full flex flex-col">
            <div id="previewContainer" class="bg-gray-800 rounded-xl shadow-2xl border border-gray-700 w-full h-full flex flex-col items-center justify-center relative overflow-hidden">
                
                <div id="loader" class="hidden absolute inset-0 bg-gray-900/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
                    <div class="banana-loader mb-4"></div><p id="loaderText" class="text-yellow-400 font-mono animate-pulse">Elaborazione...</p>
                </div>
                
                <div id="placeholder" class="text-gray-600 text-center">
                    <i class="fa-solid fa-palette text-6xl mb-4 opacity-20"></i>
                    <p class="text-gray-400">Configura e genera per iniziare.</p>
                </div>
                
                <div id="interactiveArea" class="hidden shadow-2xl relative bg-black transition-all duration-300">
                    <div id="guidesOverlay" class="absolute inset-0 pointer-events-none hidden"></div>
                    <div id="selectionBox" style="display:none;"></div>
                </div>
                
                <div id="barcodeArea" class="hidden flex flex-col items-center justify-center">
                    <div id="barcodeLines"></div>
                    <div id="barcodeText">ISBN 978-0-00-000000-0</div>
                </div>
                
                <div class="absolute bottom-4 left-0 right-0 flex justify-center pointer-events-none">
                    <div id="canvasDimensionsDisplay" class="text-[10px] text-orange-200 font-mono bg-gray-900/80 rounded px-3 py-1 border border-gray-700 hidden backdrop-blur"></div>
                </div>
                
                <canvas id="exportCanvas" class="hidden"></canvas>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiKey = "AIzaSyDrxA7ckKRgL5T5ga0KGzEVF7BUOjcW4OE"; 
            const state = { 
                mode: 'kindle', 
                generatedImageB64: null, 
                originalImageB64: null, 
                printFrontImage: null, 
                styleReferenceB64: null,
                elements: [], 
                selectedElementId: null, 
                idCounter: 0, 
                canvasScale: 1,
                paperbackLayout: null,
                isSelectingArea: false,
                selectionStart: {x:0,y:0}
            };
            
            // --- ELEMENT REFERENCES ---
            const els = {
                titleInput: document.getElementById('titleInput'), 
                mood: document.getElementById('mood'),
                styleGenre: document.getElementById('styleGenre'),
                runAgentsBtn: document.getElementById('runAgentsBtn'),
                modificationArea: document.getElementById('modificationArea'),
                modificationPrompt: document.getElementById('modificationPrompt'),
                modifyArtworkBtn: document.getElementById('modifyArtworkBtn'),
                undoBtn: document.getElementById('undoBtn'),
                designStudio: document.getElementById('designStudio'),
                exportSection: document.getElementById('exportSection'),
                printSection: document.getElementById('printSection'), 
                initPaperbackBtn: document.getElementById('initPaperbackBtn'),
                previewContainer: document.getElementById('previewContainer'),
                interactiveArea: document.getElementById('interactiveArea'),
                placeholder: document.getElementById('placeholder'),
                loader: document.getElementById('loader'),
                toggleBarcode: document.getElementById('toggleBarcode'),
                toggleGuides: document.getElementById('toggleGuides'),
                barcodeArea: document.getElementById('barcodeArea'),
                guidesOverlay: document.getElementById('guidesOverlay'),
                trimSizeInput: document.getElementById('trimSizeInput'),
                pageCountInput: document.getElementById('pageCountInput'),
                paperTypeInput: document.getElementById('paperTypeInput'),
                spineWidthDisplay: document.getElementById('spineWidthDisplay'),
                canvasDimensionsDisplay: document.getElementById('canvasDimensionsDisplay'),
                exportCanvas: document.getElementById('exportCanvas'),
                textInspector: document.getElementById('textInspector'),
                inspectorPlaceholder: document.getElementById('inspectorPlaceholder'),
                selectedTextInput: document.getElementById('selectedTextInput'),
                addGenericTextBtn: document.getElementById('addGenericTextBtn'),
                colorPicker: document.getElementById('colorPicker'),
                spineColorInput: document.getElementById('spineColorInput'),
                backColorInput: document.getElementById('backColorInput'),
                resetBtn: document.getElementById('resetBtn'),
                downloadKindleBtn: document.getElementById('downloadKindleBtn'),
                downloadPrintBtn: document.getElementById('downloadPrintBtn'),
                // New controls
                fontSelector: document.getElementById('fontSelector'),
                boldBtn: document.getElementById('boldBtn'),
                italicBtn: document.getElementById('italicBtn'),
                alignLeftBtn: document.getElementById('alignLeftBtn'),
                alignCenterBtn: document.getElementById('alignCenterBtn'),
                alignRightBtn: document.getElementById('alignRightBtn'),
                sizeInput: document.getElementById('sizeInput'),
                rotationInput: document.getElementById('rotationInput'),
                deleteElementBtn: document.getElementById('deleteElementBtn'),
                centerElementBtn: document.getElementById('centerElementBtn'),
                textSpecificControls: document.getElementById('textSpecificControls'),
                shapeSpecificControls: document.getElementById('shapeSpecificControls'),
                imageInspector: document.getElementById('imageInspector'),
                shapeWidthInput: document.getElementById('shapeWidthInput'),
                shapeHeightInput: document.getElementById('shapeHeightInput'),
                shapeRadiusInput: document.getElementById('shapeRadiusInput'),
                borderRadiusControl: document.getElementById('borderRadiusControl'),
                aiStyleBtn: document.getElementById('aiStyleBtn'),
                addSpineTextBtn: document.getElementById('addSpineTextBtn'),
                spineTextInput: document.getElementById('spineTextInput'),
                centerSpineTextBtn: document.getElementById('centerSpineTextBtn'),
                addBackTextBtn: document.getElementById('addBackTextBtn'),
                backTextInput: document.getElementById('backTextInput'),
                centerBackTextBtn: document.getElementById('centerBackTextBtn'),
                addBackImageInput: document.getElementById('addBackImageInput'),
                addRectBtn: document.getElementById('addRectBtn'),
                addCircleBtn: document.getElementById('addCircleBtn'),
                addFlagBtn: document.getElementById('addFlagBtn'),
                addBadgeBtn: document.getElementById('addBadgeBtn'),
                addBulletBtn: document.getElementById('addBulletBtn'),
                imgSizeInput: document.getElementById('imgSizeInput'),
                imgRotationInput: document.getElementById('imgRotationInput'),
                deleteImageBtn: document.getElementById('deleteImageBtn'),
                spineTools: document.getElementById('spineTools')
            };

            // --- HELPER FUNCTIONS ---
            function performReset() { if(confirm('Resettare tutto?')) location.reload(); }
            
            function updatePrintCalculations() {
                const [w, h] = els.trimSizeInput.value.split('x').map(parseFloat);
                const pages = parseInt(els.pageCountInput.value) || 100;
                const paperType = els.paperTypeInput.value;
                let paperThickness = (paperType === 'cream') ? 0.0025 : (paperType === 'color' ? 0.002347 : 0.002252);
                const spine = pages * paperThickness; 
                const bleed = 0.125;
                const totalW_inch = bleed + w + spine + w + bleed;
                const totalH_inch = bleed + h + bleed;
                const dpi = 300;
                const pxW = Math.ceil(totalW_inch * dpi);
                const pxH = Math.ceil(totalH_inch * dpi);
                els.spineWidthDisplay.innerText = `${spine.toFixed(3)}"`;
                if(state.mode === 'paperback') els.canvasDimensionsDisplay.innerText = `${pxW} x ${pxH} px (300 DPI)`;
                return { pxW, pxH, frontPx: w*dpi, spinePx: spine*dpi, bleedPx: bleed*dpi, trimW: w, trimH: h, spineInch: spine };
            }

            // --- CANVAS LOGIC & RESIZING ---
            function initKindleCanvas() {
                state.mode = 'kindle';
                els.interactiveArea.style.transform = 'none';
                
                // Logica "Contain" per Kindle (2:3 aspect ratio)
                const containerW = els.previewContainer.clientWidth - 40; 
                const containerH = els.previewContainer.clientHeight - 40;
                const targetRatio = 2/3;
                let finalW, finalH;

                if (containerW / containerH > targetRatio) {
                    finalH = containerH;
                    finalW = finalH * targetRatio;
                } else {
                    finalW = containerW;
                    finalH = finalW / targetRatio;
                }

                els.interactiveArea.style.width = finalW + 'px';
                els.interactiveArea.style.height = finalH + 'px';
                els.interactiveArea.style.backgroundImage = `url(${state.generatedImageB64})`;
                els.interactiveArea.style.backgroundSize = 'cover';
                
                els.placeholder.classList.add('hidden');
                els.interactiveArea.classList.remove('hidden');
                els.printSection.classList.add('hidden');
                els.barcodeArea.classList.add('hidden');
                
                state.canvasScale = finalW / 1600; // Reference scale relative to high res
                renderAllElements();
            }

            function initPaperbackMode() {
                if(!state.generatedImageB64) return alert("Genera prima la copertina!");
                state.mode = 'paperback';
                const calc = updatePrintCalculations();
                
                // Logica "Contain" per Paperback (Variable aspect ratio)
                const containerW = els.previewContainer.clientWidth - 40;
                const containerH = els.previewContainer.clientHeight - 40;
                const targetRatio = calc.pxW / calc.pxH;
                let finalW, finalH;

                if (containerW / containerH > targetRatio) {
                    finalH = containerH;
                    finalW = finalH * targetRatio;
                } else {
                    finalW = containerW;
                    finalH = finalW / targetRatio;
                }
                
                els.interactiveArea.style.width = finalW + 'px';
                els.interactiveArea.style.height = finalH + 'px';
                
                els.placeholder.classList.add('hidden');
                els.interactiveArea.classList.remove('hidden');
                els.canvasDimensionsDisplay.classList.remove('hidden');
                els.spineTools.classList.remove('hidden');
                els.downloadPrintBtn.classList.remove('hidden');

                // Draw Background
                const bgCanvas = document.createElement('canvas');
                bgCanvas.width = calc.pxW; bgCanvas.height = calc.pxH;
                const ctx = bgCanvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    ctx.fillStyle = els.backColorInput.value; ctx.fillRect(0,0, calc.pxW, calc.pxH);
                    ctx.fillStyle = els.spineColorInput.value; ctx.fillRect(calc.bleedPx + calc.frontPx, 0, calc.spinePx, calc.pxH);
                    const fx = calc.bleedPx + calc.frontPx + calc.spinePx;
                    const fw = calc.frontPx + calc.bleedPx;
                    const fh = calc.pxH;
                    const iRatio = img.width / img.height;
                    const tRatio = fw / fh;
                    let dw, dh, dx, dy;
                    if(iRatio > tRatio) { dh = fh; dw = fh * iRatio; dx = fx + (fw-dw)/2; dy = 0; }
                    else { dw = fw; dh = fw / iRatio; dx = fx; dy = (fh-dh)/2; }
                    ctx.save(); ctx.beginPath(); ctx.rect(fx, 0, fw, fh); ctx.clip();
                    ctx.drawImage(img, dx, dy, dw, dh); ctx.restore();
                    els.interactiveArea.style.backgroundImage = `url(${bgCanvas.toDataURL()})`;
                };
                img.src = state.generatedImageB64;
                
                state.paperbackLayout = calc;
                state.canvasScale = finalW / calc.pxW; 
                
                // Re-append overlays
                if(!els.interactiveArea.contains(els.barcodeArea)) els.interactiveArea.appendChild(els.barcodeArea);
                
                updateBarcodePosition();
                renderAllElements();
                
                // Show guides if checked
                if(els.toggleGuides.checked) drawKDPGuides(calc, finalW, finalH);
            }

            function updateBarcodePosition() {
                if(!state.paperbackLayout) return;
                const scale = state.canvasScale;
                const margin = 0.35 * 300 * scale;
                const backW = (state.paperbackLayout.bleedPx + state.paperbackLayout.frontPx) * scale;
                const barW = 90; const barH = 55;
                els.barcodeArea.style.left = (backW - barW - margin) + 'px';
                els.barcodeArea.style.top = (parseFloat(els.interactiveArea.style.height) - (state.paperbackLayout.bleedPx*scale) - barH - margin) + 'px';
            }

            function drawKDPGuides(calc, viewW, viewH) {
                const scale = state.canvasScale;
                const bleed = calc.bleedPx * scale;
                const guideCont = els.guidesOverlay;
                guideCont.innerHTML = '';
                
                // Trim Line
                const trim = document.createElement('div'); trim.className='kdp-trim-line';
                trim.style.left=bleed+'px'; trim.style.top=bleed+'px'; trim.style.width=(viewW-bleed*2)+'px'; trim.style.height=(viewH-bleed*2)+'px';
                guideCont.appendChild(trim);
                
                // Spine Fold
                const fold = document.createElement('div'); fold.className='kdp-spine-fold';
                fold.style.left = (calc.bleedPx+calc.frontPx)*scale + 'px';
                fold.style.width = calc.spinePx*scale + 'px';
                guideCont.appendChild(fold);
            }

            // --- ELEMENT MANAGEMENT ---
            function addElement(type, content) {
                const id = `el_${state.idCounter++}`;
                const el = { id, type, content, x: 50, y: 50, rotation: 0, width: 100, height: 100, style: { color: '#ffffff', fontSize: 30, fontFamily: 'Inter, sans-serif', textAlign: 'center' } };
                if (type === 'shape') { el.shapeType = content; el.style.color = '#F59E0B'; }
                if (type === 'image') { el.width = 150; el.src = content; }
                state.elements.push(el);
                renderElementDOM(el);
                selectElement(id);
                return id;
            }

            function renderElementDOM(el) {
                const div = document.createElement('div');
                div.id = el.id;
                div.className = 'draggable-item';
                div.style.left = el.x + 'px';
                div.style.top = el.y + 'px';
                
                if(el.type === 'text') {
                    div.innerText = el.content;
                    div.style.fontSize = el.style.fontSize + 'px';
                    div.style.color = el.style.color;
                    div.style.fontFamily = el.style.fontFamily;
                    div.style.fontWeight = el.style.fontWeight;
                    div.style.fontStyle = el.style.fontStyle;
                    div.style.textAlign = el.style.textAlign;
                } else if(el.type === 'shape') {
                    div.style.width = el.width + 'px';
                    div.style.height = (el.height||el.width) + 'px';
                    div.style.backgroundColor = el.style.color;
                    if(el.shapeType === 'circle') div.style.borderRadius = '50%';
                    if(el.shapeType === 'rect') div.style.borderRadius = (el.borderRadius||0)+'px';
                } else if(el.type === 'image') {
                    const img = document.createElement('img');
                    img.src = el.src;
                    img.style.width = el.width + 'px';
                    div.appendChild(img);
                }
                
                div.style.transform = `rotate(${el.rotation}deg)`;
                
                div.addEventListener('mousedown', startDrag);
                div.addEventListener('click', (e) => { e.stopPropagation(); selectElement(el.id); });
                els.interactiveArea.appendChild(div);
            }

            function renderAllElements() {
                // Clear only elements, keep overlays
                Array.from(els.interactiveArea.children).forEach(c => {
                    if(c.id.startsWith('el_')) c.remove();
                });
                state.elements.forEach(renderElementDOM);
            }

            function selectElement(id) {
                state.selectedElementId = id;
                els.inspectorPlaceholder.classList.add('hidden');
                const el = state.elements.find(e => e.id === id);
                if(el) {
                    els.textInspector.classList.remove('hidden');
                    if(el.type === 'text') {
                        els.textSpecificControls.classList.remove('hidden');
                        els.shapeSpecificControls.classList.add('hidden');
                        els.imageInspector.classList.add('hidden');
                        els.selectedTextInput.value = el.content;
                        els.sizeInput.value = parseInt(el.style.fontSize);
                    } else if (el.type === 'shape') {
                        els.textSpecificControls.classList.add('hidden');
                        els.shapeSpecificControls.classList.remove('hidden');
                        els.imageInspector.classList.add('hidden');
                        els.shapeWidthInput.value = el.width;
                        els.shapeHeightInput.value = el.height || el.width;
                    } else if (el.type === 'image') {
                        els.textSpecificControls.classList.add('hidden');
                        els.shapeSpecificControls.classList.add('hidden');
                        els.imageInspector.classList.remove('hidden');
                        els.imgSizeInput.value = el.width;
                    }
                    els.colorPicker.value = el.style.color || '#ffffff';
                    els.rotationInput.value = el.rotation;
                }
            }

            // Drag Logic
            let dragged = null, startX=0, startY=0;
            function startDrag(e) {
                if(state.isSelectingArea) return;
                dragged = e.currentTarget;
                const rect = dragged.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                selectElement(dragged.id);
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', endDrag);
            }
            function onDrag(e) {
                if(!dragged) return;
                const cont = els.interactiveArea.getBoundingClientRect();
                const x = e.clientX - cont.left - startX;
                const y = e.clientY - cont.top - startY;
                dragged.style.left = x + 'px';
                dragged.style.top = y + 'px';
                const el = state.elements.find(i => i.id === dragged.id);
                if(el) { el.x = x; el.y = y; }
            }
            function endDrag() { dragged = null; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', endDrag); }

            // --- LISTENERS ---
            els.runAgentsBtn.addEventListener('click', async () => {
                const p = els.titleInput.value + " " + els.mood.value + " book cover";
                if(!els.titleInput.value) return alert("Inserisci almeno il titolo");
                els.loader.classList.remove('hidden');
                try {
                    const seed = Math.floor(Math.random() * 99999);
                    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?width=800&height=1200&nologo=true&seed=${seed}`;
                    const res = await fetch(url);
                    const blob = await res.blob();
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        state.generatedImageB64 = reader.result;
                        els.loader.classList.add('hidden');
                        els.designStudio.classList.remove('hidden');
                        els.exportSection.classList.remove('hidden');
                        els.printSection.classList.remove('hidden');
                        els.modificationArea.classList.remove('hidden');
                        initKindleCanvas();
                    };
                    reader.readAsDataURL(blob);
                } catch(e) { alert("Errore generazione"); els.loader.classList.add('hidden'); }
            });

            els.initPaperbackBtn.addEventListener('click', initPaperbackMode);
            els.resetBtn.addEventListener('click', performReset);
            
            // Adding Elements
            els.addGenericTextBtn.addEventListener('click', () => addElement('text', 'Testo'));
            els.addRectBtn.addEventListener('click', () => addElement('shape', 'rect'));
            els.addCircleBtn.addEventListener('click', () => addElement('shape', 'circle'));
            els.addFlagBtn.addEventListener('click', () => addElement('shape', 'flag')); // Placeholder shape logic
            
            // Interactions
            els.selectedTextInput.addEventListener('input', (e) => {
                const el = state.elements.find(x => x.id === state.selectedElementId);
                if(el) { el.content = e.target.value; document.getElementById(el.id).innerText = e.target.value; }
            });
            
            els.sizeInput.addEventListener('input', (e) => {
                const el = state.elements.find(x => x.id === state.selectedElementId);
                if(el && el.type === 'text') { el.style.fontSize = parseInt(e.target.value); document.getElementById(el.id).style.fontSize = e.target.value + 'px'; }
            });
            
            els.rotationInput.addEventListener('input', (e) => {
                const el = state.elements.find(x => x.id === state.selectedElementId);
                if(el) { el.rotation = parseInt(e.target.value); document.getElementById(el.id).style.transform = `rotate(${el.rotation}deg)`; }
            });

            els.colorPicker.addEventListener('input', (e) => {
                const el = state.elements.find(x => x.id === state.selectedElementId);
                if(el) { 
                    el.style.color = e.target.value; 
                    const dom = document.getElementById(el.id);
                    el.type === 'text' ? dom.style.color = e.target.value : dom.style.backgroundColor = e.target.value;
                }
            });

            els.deleteElementBtn.addEventListener('click', () => {
                if(state.selectedElementId) {
                    document.getElementById(state.selectedElementId).remove();
                    state.elements = state.elements.filter(e => e.id !== state.selectedElementId);
                    state.selectedElementId = null;
                    els.textInspector.classList.add('hidden');
                    els.inspectorPlaceholder.classList.remove('hidden');
                }
            });

            // Toggle Visuals
            els.toggleBarcode.addEventListener('change', (e) => {
                e.target.checked ? els.barcodeArea.classList.remove('hidden') : els.barcodeArea.classList.add('hidden');
                if(state.mode === 'paperback') updateBarcodePosition();
            });
            
            els.toggleGuides.addEventListener('change', (e) => {
                e.target.checked ? els.guidesOverlay.classList.remove('hidden') : els.guidesOverlay.classList.add('hidden');
                if(state.mode === 'paperback' && e.target.checked) {
                    const w = parseFloat(els.interactiveArea.style.width);
                    const h = parseFloat(els.interactiveArea.style.height);
                    drawKDPGuides(state.paperbackLayout, w, h);
                }
            });

            // Spine Text Logic
            els.addSpineTextBtn.addEventListener('click', () => {
                if(state.mode !== 'paperback') return alert("Solo in Paperback mode");
                const id = addElement('text', els.spineTextInput.value || 'Spina');
                const el = state.elements.find(x => x.id === id);
                el.rotation = -90; document.getElementById(id).style.transform = 'rotate(-90deg)';
                el.style.fontSize = 12; document.getElementById(id).style.fontSize = '12px';
            });
            
            els.centerSpineTextBtn.addEventListener('click', () => {
                if(!state.selectedElementId) return;
                const calc = state.paperbackLayout;
                const scale = state.canvasScale;
                const centerX = (calc.bleedPx + calc.frontPx + (calc.spinePx/2)) * scale;
                const dom = document.getElementById(state.selectedElementId);
                const w = dom.offsetWidth;
                const el = state.elements.find(x => x.id === state.selectedElementId);
                el.x = centerX - (w/2);
                dom.style.left = el.x + 'px';
            });

            // Immediate Layout Updates
            els.spineColorInput.addEventListener('input', () => { if(state.mode==='paperback') initPaperbackMode(); });
            els.backColorInput.addEventListener('input', () => { if(state.mode==='paperback') initPaperbackMode(); });
            
            window.addEventListener('resize', () => {
                if(state.mode === 'kindle') initKindleCanvas();
                if(state.mode === 'paperback') initPaperbackMode();
            });
        });
    </script>
</body>
</html>